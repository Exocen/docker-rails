#!/bin/bash
# Enviroment vars needed:
#   APP_NAME: The app name
#   APP_REPO_URL: The git repo where to clone the app, e.g. https://<token>@github.com/owner/repo.git
#   RAILS_ENV: The Rails environment, e.g. "production"
#   DATABASE_URL: e.g. "postgres://myuser:mypass@localhost/somedatabase"
trap 'exit' ERR

source /etc/profile.d/rvm.sh
export rvm_install_on_use_flag=1

mkdir /srv/$APP_NAME
cd /srv/$APP_NAME

git clone --depth 1 $APP_REPO_URL .
rm -f config/database.yml

rvm use .

bundle install

if ! gem spec passenger > /dev/null 2>&1; then
  gem install passenger --no-document
fi

rake db:create
rake db:migrate

passenger start -p 80 -e $RAILS_ENV
